<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>Занятие 47</title>
    <link rel="shortcut icon" href="./../favicon.ico" />
    <link rel="stylesheet" href="./../dist/reset.css" />
    <link rel="stylesheet" href="./../dist/reveal.css" />
    <link rel="stylesheet" href="./../dist/theme/white.css" id="theme" />
    <link rel="stylesheet" href="./../css/highlight/base16/zenburn.css" />

    <link rel="stylesheet" href="./../_assets/.reveal-md/styles.css" />


    <script>
      document.write(
        '<script src="http://' +
          (location.host || 'localhost').split(':')[0] +
          ':35729/livereload.js?snipver=1"></' +
          'script>'
      );
    </script>
  </head>
  <body>
    <div class="reveal">
      <div class="slides"><section ><section data-markdown><script type="text/template">

# OTUS

## Javascript Basic

</script></section><section data-markdown><script type="text/template">

Вопросы?

</script></section></section><section ><section data-markdown><script type="text/template">

### history (библиотека)

</script></section><section data-markdown><script type="text/template">

```bash
npm i history
```

</script></section><section data-markdown><script type="text/template">

```js [1-100]
import { createBrowserHistory } from "history";
// еще есть createHashHistory и createMemoryHistory

const history = createBrowserHistory();

// читаем
const location = history.location;

// Подписываемся
const unlisten = history.listen((location, action) => {
  // location is an object like window.location
  console.log(action, location.pathname, location.state);
});

// API — совместимый с HTML5 History
history.push("/home", { some: "state" });

// отписаться
unlisten();
```

</script></section><section data-markdown><script type="text/template">

## Вопросы?

</script></section></section><section ><section data-markdown><script type="text/template">

### [React-router](https://reactrouter.com/)

</script></section><section data-markdown><script type="text/template">

### React-router: что это?

- **React-router** — библиотека для клиентского роутинга в реакт-приложениях:
  - Подписываться на изменения URL и обновлять приложение
  - “Виртуальные” ссылки
  - Парсит пути, достает параметры
- Будем смотреть на react-router v5
- Философия — описание роутов в виде компонентов

</script></section><section data-markdown><script type="text/template">

```jsx [1-100]
import React from "react";
import { BrowserRouter, Route } from "react-router-dom";
import News from "./News";

// BrowserRouter создает объект history и прокидывает
// его вниз
// Можно также HashRouter / MemoryRouter
const App = () => (
  <BrowserRouter>
    {/* Route просто описывает пути */}
    <Route exact path="/" component={Home} />
    {/* Вместо component можно render */}
    <Route exact path="/news" render={() => <News />} />
    <Route path="/category" component={Category} />
  </BrowserRouter>
);
// как называется паттерн в Route?)
// зачем нужен exact?
```

</script></section><section data-markdown><script type="text/template">

### Вложенные Route

```jsx [1-100]
import React from "react";
import { BrowserRouter, Route, Switch } from "react-router-dom";
import News from "./News";

// также обратите внимание на Switch
const Category = () => (
  <Switch>
    <Route exact path="/" component={CatList} />
    <Route exact path="/:catid" component={CatPage} />
  </Switch>
);

const App = () => (
  <BrowserRouter>
    {/* Route просто описывает пути */}
    <Route exact path="/" component={Home} />
    {/* Вместо component можно render */}
    <Route exact path="/news" render={() => <News />} />
    <Route path="/category" component={Category} />
  </BrowserRouter>
);
```

</script></section><section data-markdown><script type="text/template">

### Route с параметрами

<!-- eslint-skip -->

```jsx [1-100]
import React from "react";

const CatPage = ({ match }) => <h1>Viewing category {match.params.catid}</h1>;

const Category = () => (
  <Switch>
    <Route exact path="/" component={CatList} />
    <Route exact path="/:catid" component={CatPage} />
  </Switch>
);
```

</script></section><section data-markdown><script type="text/template">

### Действия при входе

```jsx [1-100]
class CatPage extends Component {
  // используем лайфсайкл-хук
  componentDidMount() {
    get(`/goods/${this.props.catid}`).then(/*...*/);
  }
  componentDidUpdate() {
    // стандарто: проверка изменения & load
  }
  render() {
    const { match } = this.props;
    const { list = [] } = this.state;
    return (
      <div>
        <h1>Viewing category {match.params.catid}</h1>
      </div>
    );
  }
}

const Category = () => (
  <Switch>
    <Route exact path="/" component={CatList} />
    <Route exact path="/:catid" component={CatPage} />
  </Switch>
);
```

</script></section><section data-markdown><script type="text/template">

## Вопросы?

</script></section><section data-markdown><script type="text/template">

### Задание

- Пишем структуру роутов для интернет-магазина
  - список
  - категории
  - страницы товаров
  - не-магазинные страницы (контакты, блог).
- присылайте в чат!

</script></section><section data-markdown><script type="text/template">

## Вопросы?

</script></section></section><section ><section data-markdown><script type="text/template">

### `<Link />`

</script></section><section data-markdown><script type="text/template">

- У элемента **`<a>`** на самом деле куча полезной функциональности:
  - контекстное меню
  - _ctrl / alt + click_ — открыть в новой вкладке / сохранить
  - **`<a>`** можно даже перетаскивать!
- Если вместо **`<a>`** рисовать

```jsx [1-100]
<span onClick={() => history.pushState(/*...*/)}>link</span>
```

то мы теряем всю браузерную обвеску.

- С другой стороны **`<a>`** по умолчанию

</script></section><section data-markdown><script type="text/template">

<!-- eslint-skip -->

```jsx [1-100]
import { Link } from "react-router-dom";
// Хитрая ссылка
<Link to="/news">Новости!</Link>

// можно generatePath
<Link
  to={ generatePath("/user/:id/", { id }) }
>{ name }</Link>

// или просто руками:
<Link to={ `/user/${id}/` }>{ name }</Link>

// или объектом
const target = {
    pathname: "/courses",
    search: "?sort=name",
    hash: "#the-hash",
    state: { fromDashboard: true }
  };
<Link
  to={target}
/>
```

</script></section><section data-markdown><script type="text/template">

### Внешние ссылки

<!-- eslint-skip -->

```jsx [1-100]
//у Link есть подвох
// если на https://vasya-superman.ru написать
<Link to="https://mail.yandex.ru">Yandex.Mail</Link>

// то получится
<a href="https://vasya-superman.ru/https://mail.yandex.ru">
  Yandex.Mail
</a>

// это скорее всего не то, чего мы хотели

// Обход 1 — писать руками <a> для внешних ссылок
// Обход 2 — написать обертку <SmartLink>, которая смотрит на URL,
// проверяет, абсолютный ли он, и рисует <Link>или <a>
```

</script></section><section data-markdown><script type="text/template">

Задание: реализуйте SmartLink

</script></section><section data-markdown><script type="text/template">

### Redirect

<!-- eslint-skip -->

```jsx [1-100]
import { Redirect } from "react-router-dom";
// Рендерим Redirect - переходим по адресу
<Redirect to="/view-ad" />

// или прямо в списке роутов (допустим, миграция):
<HashRouter>
  <Redirect from="/user-list" to="/users" />
</HashRouter>

// Более полезный кейс:
const withAuth = Cmp => props => {
  return props.user
    ? <Cmp { ...props } />
    : <Redirect to="/login" />;
};
```

</script></section><section data-markdown><script type="text/template">

### Парсим query string

```jsx [1-100]
// Противоречивое решение react-router v4:
// убрать работу с queryString
// Теперь все сами:

import queryString from "query-string";

const Page = ({ location }) => {
  const params = queryString.parse(location.search);
  return <GoodsSearch name={params.name} minPrice={params.minPrice} />;
};
```

</script></section><section data-markdown><script type="text/template">

Задание:
`withRouter` подкладывает в пропсы `location` и `match`
напишите `withQuery`, который подкладывает queryParams

</script></section><section data-markdown><script type="text/template">

### react-router: парсим query string

[query parameters react router way](https://reactrouter.com/web/example/query-parameters)

</script></section><section data-markdown><script type="text/template">

## Вопросы?

</script></section></section><section ><section data-markdown><script type="text/template">

### [Разделение кода на основе маршрутов](https://ru.reactjs.org/docs/code-splitting.html#route-based-code-splitting)

</script></section><section data-markdown><script type="text/template">

Современный стандарт описывает [динамическую подгрузку модулей](https://developer.mozilla.org/ru/docs/Web/JavaScript/Guide/Modules#dynamic_module_loading).

```js [1-100]
import("./modules/myModule.js").then((module) => {
  // Do something with the module.
});
```

Полный пример можно посмотреть [здесь](https://github.com/mdn/js-examples/tree/master/modules/dynamic-module-imports)

</script></section><section data-markdown><script type="text/template">

React на стороне клиента предоставляет поддержку ленивой загрузки через [`lazy` api](https://ru.reactjs.org/docs/code-splitting.html#reactlazy)

</script></section><section data-markdown><script type="text/template">

При этом мы даже можем визуализировать процесс загрузки через

```js [1-100]
import React, { Suspense } from "react";

const OtherComponent = React.lazy(() => import("./OtherComponent"));

function MyComponent() {
  return (
    <div>
      <Suspense fallback={<div>Загрузка...</div>}>
        <OtherComponent />
      </Suspense>
    </div>
  );
}
```

</script></section><section data-markdown><script type="text/template">

Иногда это используют, для разделения кода, в зависимости от роута

```js [1-100]
import React, { Suspense, lazy } from "react";
import { BrowserRouter as Router, Route, Switch } from "react-router-dom";

const Home = lazy(() => import("./routes/Home"));
const About = lazy(() => import("./routes/About"));

const App = () => (
  <Router>
    <Suspense fallback={<div>Загрузка...</div>}>
      <Switch>
        <Route exact path="/" component={Home} />
        <Route path="/about" component={About} />
      </Switch>
    </Suspense>
  </Router>
);
```

</script></section><section data-markdown><script type="text/template">

Замечание про [именованный экспорт](https://ru.reactjs.org/docs/code-splitting.html#named-exports)

```js [1-100]
const HugeComponent = React.lazy(() =>
  import("./HugeComponent").then((module) => ({
    default: module.HugeComponent,
  }))
);
```

</script></section><section data-markdown><script type="text/template">

Вопросы?

</script></section></section><section ><section data-markdown><script type="text/template">

### Дополнительные материалы

1. [Разделение кода](https://ru.reactjs.org/docs/code-splitting.html#named-exports)
1. [Code Splitting React Router Routes with React Lazy and React Suspense](https://karlhadwen.medium.com/code-splitting-react-router-routes-with-react-lazy-and-react-suspense-a3852b42c0a9)
1. [React router examples](https://reactrouter.com/web/guides/quick-start)
1. [React Router v5: The Complete Guide](https://www.sitepoint.com/react-router-complete-guide/)

</script></section><section data-markdown><script type="text/template">

### [Домашнее задание](https://github.com/vvscode/otus--javascript-basic/blob/master/lessons/lesson47/homework.md)
</script></section></section></div>
    </div>

    <script src="./../dist/reveal.js"></script>

    <script src="./../plugin/markdown/markdown.js"></script>
    <script src="./../plugin/highlight/highlight.js"></script>
    <script src="./../plugin/zoom/zoom.js"></script>
    <script src="./../plugin/notes/notes.js"></script>
    <script src="./../plugin/math/math.js"></script>
    <script>
      function extend() {
        var target = {};
        for (var i = 0; i < arguments.length; i++) {
          var source = arguments[i];
          for (var key in source) {
            if (source.hasOwnProperty(key)) {
              target[key] = source[key];
            }
          }
        }
        return target;
      }

      // default options to init reveal.js
      var defaultOptions = {
        controls: true,
        progress: true,
        history: true,
        center: true,
        transition: 'default', // none/fade/slide/convex/concave/zoom
        plugins: [
          RevealMarkdown,
          RevealHighlight,
          RevealZoom,
          RevealNotes,
          RevealMath
        ]
      };

      // options from URL query string
      var queryOptions = Reveal().getQueryHash() || {};

      var options = extend(defaultOptions, {"slideNumber":true,"hash":true,"history":false,"backgroundTransition":"fade","width":"80%","tableofcontents":{"title":"План","position":1000}}, queryOptions);
    </script>

    <script src="./../_assets/plugins.js"></script>

    <script>
      Reveal.initialize(options);
    </script>
  </body>
</html>
